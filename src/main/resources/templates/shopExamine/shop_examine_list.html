<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="utf-8">
	<title>文章列表--layui后台管理模板</title>
	<meta name="renderer" content="webkit">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="format-detection" content="telephone=no">
	<link rel="stylesheet" href="/plugins/layui/css/layui.css" media="all" />
</head>
<body>
<div class="layui-form" style="margin-top: 5px; margin-left: 10px">
	身份证号码：
	<div class="layui-inline">
		<input class="layui-input layui-input-sm" name="idCardNo" autocomplete="off">
	</div>
	申请状态：
	<div class="layui-inline">
		<select lay-filter="status" name="status" data-type="reload">
			<option value="">全部</option>
			<option value="0">待审核</option>
			<option value="1">审核通过</option>
			<option value="2">审核拒绝</option>
		</select>
	</div>
	<button class="layui-btn" lay-submit type="submit">搜索</button>
</div>

<table class="layui-hide" id="LAY_table_user" lay-filter="user"></table>


<script type="text/javascript" src="/plugins/layui/layui.js"  charset="utf-8"></script>
<script type="text/html" id="status">
	{{#  if(d.status == 1){ }}
		审核通过
	{{#  } else if(d.status == 0){ }}
		待审核
	{{#  } else if(d.status == 2){ }}
		审核拒绝
	{{# } }}
</script>
<script type="text/html" id="shopModel">
	{{# function getData(key) { }}
	{{# var arr = key.split('.'); }}
	{{# var temp = ''; }}
	{{# arr.forEach(function(value,index){ }}
	{{# if(index == 0){ }}
	{{# if(d[value] != null && typeof(d[value]) != 'undefined'){ }}
	{{# temp = d[value]; }}
	{{# }else{ }}
	{{# temp = ''; }}
	{{# } }}
	{{# }else { }}
	{{# if(temp[value] != null && typeof(temp[value]) != 'undefined'){ }}
	{{# temp = temp[value]; }}
	{{# }else{ }}
	{{# temp = ''; }}
	{{# } }}
	{{# } }}
	{{# }); }}
	{{# return temp; }}
	{{# } }}

	{{ getData(d.param.path) }}
</script>
<script>
    function refrersh() {

        window.location.Reload();
    }

    layui.use('table', function(){
        var table = layui.table,form = layui.form,$=layui.$;
        //方法级渲染
        table.render({
            elem: '#LAY_table_user'

            ,url: '/shopExamine/ui/list'
            ,cols: [[
                {checkbox: true, fixed: true},
                {field:'id', width:80, title: 'ID', sort: true}
                ,{field:'headImg', width:100, title: '店铺头像', templet:'<div><img src="http://youmehe.oss-cn-beijing.aliyuncs.com/image/{{d.headImg}}"></div>'}
                ,{field:'shopName', width:120, title: '店铺名称'}
                ,{field:'address', width:120, title: '店铺地址'}
                ,{field:'legalPersonName', width:120, title: '法人姓名'}
                ,{field:'phone', width:100, title: '用户电话',templet:'#shopModel?path=shopUser.phone'}
                ,{field:'idCardNo', width:120, title: '身份证号码'}
                ,{field:'cardFront', width:120, title: '身份证正面图', templet:'<div><img src="http://youmehe.oss-cn-beijing.aliyuncs.com/image/{{d.cardFront}}"></div>'}
                ,{field:'cardBack', width:120, title: '身份证背面图', templet:'<div><img src="http://youmehe.oss-cn-beijing.aliyuncs.com/image/{{d.cardBack}}"></div>'}
                ,{field:'status', width:120, title: '审核状态',templet:'#status'}
                ,{field:'desc', width:120, title: '拒绝原因'}
                ,{field:'publishTime', width:165, title: '申请时间'}
                ,{fixed: 'right', width:170, align:'center', toolbar: '#barDemo'} //这里的toolbar值是模板元素的选择器
            ]]
            ,id: 'testReload'
            ,page: true
            ,limit: 10
            ,height: 'full-65'
        });

        form.render().on('submit', function(obj){
            var data = obj.field;
            //执行重载
            table.reload('testReload', {
                page: {
                    curr: $('#page').val, //重新从第 1 页开始
                }
                ,where: {
                    idCardNo:data.idCardNo,
                    status:data.status
                }
            });
        });


    });
</script>

<script type="text/html" id="barDemo">
	{{# if(d.status == 0){ }}
		<a class="layui-btn layui-btn-mini" lay-event="edit">同意申请</a>
		<a class="layui-btn layui-btn-danger layui-btn-mini" data-type="test" lay-event="del">拒绝申请</a>
	{{# } }}
</script>

<script type="text/html" id="refuse">
	<ul class="layui-form" style="margin: 10px;">
		<li class="layui-form-item">
			<textarea name="desc" placeholder="请输入内容" class="layui-textarea"></textarea>
		</li>
		<li class="layui-form-item" style="text-align:center;">
			<button type="submit" lay-submit lay-filter="*" class="layui-btn">提交</button>
		</li>
	</ul>
</script>

<script>
    //监听工具条
    layui.use('table', function(){
        var table = layui.table,layer = layui.layer,$ = layui.$,form = layui.form,laytpl=layui.laytpl;

        table.on('tool(user)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的DOM对象
            console.log(obj);
            /*if(layEvent === 'detail'){ //查看
                //do somehing
                console.log(data)
            } else */
            if(layEvent === 'del'){ //删除
                layer.open({
                    type: 1
                    ,title:'拒绝原因'
                    ,area: '300px'
                    ,resize: false
                    ,content: $('#refuse').html()
                    ,success: function(layero,index){
                        layero.find('.layui-layer-content').css('overflow', 'visible');
                        form.render().on('submit(*)', function(datas){
                            $.ajax({
                                url:'/shopExamine/ui/refuse',
                                type:'POST',
                                dataType:'json',
                                data:{shopExamineId:data.id,desc:datas.field.desc},
                                success:function (res) {
                                    console.log(res);
                                    if(res.code < 2000){
                                        /*obj.update({
                                            status: '审核拒绝',
                                            desc: datas.field.desc
                                        });*/
                                        table.reload('testReload', {
                                            page: {
                                                curr: $('#page').val, //重新从第 1 页开始
                                            }
                                        });
                                    }else {
                                        layer.msg(res.msg);
                                    }
                                }
                            })
                            layer.close(index);
                        });
                    }
                });
            } else if(layEvent === 'edit'){ //编辑
                layer.confirm('您确定同意吗？', function(index){
                    layer.close(index);
                    $.ajax({
                        url:'/shopExamine/ui/adopt',
                        type:'POST',
                        dataType:'json',
                        data:{shopExamineId:data.id},
                        success:function (res) {
                            console.log(res);
                            if(res.code < 2000){
                                table.reload('testReload', {
                                    page: {
                                        curr: $('#page').val, //重新从第 1 页开始
                                    }
                                });
                            }else {
                                layer.msg("该条数据存在异常请检查");
                            }
                        }
                    })
                });
            }
        });
    });
</script>
</body>
</html>